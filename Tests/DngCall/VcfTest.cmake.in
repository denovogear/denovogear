###############################################################################
# Test if dng-call crashes on partial pedigrees

set(PartialPed-CMD @DNG_CALL_EXE@ --ped ped/duo.ped bcftools/trio.call.vcf)
set(PartialPed-WD "@TESTDATA_DIR@/human_trio/")
set(PartialPed-RESULT 0)
set(PartialPed-STDOUT
  "##PEDIGREE=<ID=LB/NA12878,Original=GL/1,OriginalMR=0.0>"
)

set(PartialPed2-CMD @DNG_CALL_EXE@ -m 0 --ped ped/trio.ped vcf/duo.vcf)
set(PartialPed2-WD "@TESTDATA_DIR@/human_trio/")
set(PartialPed2-RESULT 0)
set(PartialPed2-STDOUT
  "##PEDIGREE=<ID=LB/NA12878,Father=GL/NA12891,Mother=GL/NA12892,FatherMR=10.0e-09,MotherMR=10.0e-09>"
  "##PEDIGREE=<ID=LB/NA12892,Original=GL/NA12892,OriginalMR=0.0>"
)
set(PartialPed2-STDOUT-FAIL
  "##PEDIGREE=<ID=LB/NA12891,Original=GL/NA12891,OriginalMR=0.0>"
)

###############################################################################
# Test if dng-call crashes on empty pedigrees

set(EmptyPed-CMD @DNG_CALL_EXE@ --ped empty.ped trio.vcf)
set(EmptyPed-WD "@TESTDATA_DIR@/human_trio/")
set(EmptyPed-RESULT 0)

###############################################################################
# Test if dng-call works on a trio

set(TrioMpileup-CMD @DNG_CALL_EXE@ -p ped/trio.ped bcftools/trio.mpileup.vcf)
set(TrioMpileup-WD "@TESTDATA_DIR@/human_trio")
set(TrioMpileup-RESULT 0)
set(TrioMpileup-STDOUT
  "\r?\n#CHROM\tPOS\tID\tREF\tALT\tQUAL\tFILTER\tINFO\tFORMAT\tGL/NA12892\tGL/NA12891\tLB/NA12891\tLB/NA12878\tLB/NA12892\r?\n"
  "\r?\n5\t126385924\t\\.\tG\tT,<\\*>\t"
  "\r?\n5\t126385924\t.*\tGT:GQ:GP:MUP:MU1P:GL:DP:AD\t"
  "\r?\n5\t126385924\t.*\tMUP=0\\.999969\;"
  "\r?\n5\t126385924\t.*\;LLD=-22\\.653\;"
  "\r?\n5\t126385924\t.*\;LLS=0\\.90977\;"
  "\r?\n5\t126385924\t.*\;MUX=0\\.999969\;"
  "\r?\n5\t126385924\t.*\;MU1P=0\\.999969\;"
  "\r?\n5\t126385924\t.*\;DNT=G/GxG/G->G/T\;"
  "\r?\n5\t126385924\t.*\;DNL=LB/NA12878\;"
  "\r?\n5\t126385924\t.*\;DNQ=127\;"
  "\r?\n5\t126385924\t.*\;DP=113\;"
  "\r?\n5\t126385924\t.*\;AD=92,21,0\t"
  "\r?\n5\t126385924\t.*\t0/0:46:0\\.999973,2\\.70019e-05,0,6\\.68272e-17,0,0:0:0:\\.,\\.,\\.,\\.,\\.,\\.:\\.:\\.,\\.,\\.\t"
  "\r?\n5\t126385924\t.*\t0/0:54:0\\.999996,3\\.85718e-06,0,2\\.89294e-14,0,0:0:0:\\.,\\.,\\.,\\.,\\.,\\.:\\.:\\.,\\.,\\.\t"
  "\r?\n5\t126385924\t.*\t0/0:54:0\\.999996,3\\.85718e-06,0,2\\.89294e-14,0,0:0:0:0,-10\\.1127,-75\\.3322,-10\\.1127,-75\\.3322,-75\\.3322:34:34,0,0\t"
  "\r?\n5\t126385924\t.*\t0/1:255:6\\.2615e-31,1,8\\.45815e-38,1\\.00893e-43,1\\.77965e-43,0:1:1:-38\\.5043,0,-28\\.1696,-42\\.9961,-34\\.1479,-77\\.144:35:15,20,0\t"
  "\r?\n5\t126385924\t.*\t0/0:46:0\\.999973,2\\.70019e-05,0,6\\.68272e-17,0,0:0:0:0,-9\\.26756,-87\\.0858,-12\\.7491,-87\\.3868,-90\\.8683:44:43,1,0\r?\n"
)

set(TrioBcftoolsAutosomal-CMD @DNG_CALL_EXE@ -M autosomal -p ped/trio.ped bcftools/trio.call.vcf)
set(TrioBcftoolsAutosomal-WD "@TESTDATA_DIR@/human_trio")
set(TrioBcftoolsAutosomal-RESULT 0)
set(TrioBcftoolsAutosomal-STDOUT
  "\r?\n#CHROM\tPOS\tID\tREF\tALT\tQUAL\tFILTER\tINFO\tFORMAT\tGL/NA12892\tGL/NA12891\tLB/NA12891\tLB/NA12878\tLB/NA12892\r?\n"
  "\r?\n5\t126385924\t\\.\tG\tT\t"
  "\r?\n5\t126385924\t.*\tGT:GQ:GP:MUP:MU1P:GL:DP:AD\t"
  "\r?\n5\t126385924\t.*\tMUP=0\\.999938\;"
  "\r?\n5\t126385924\t.*\;LLD=-22\\.653\;"
  "\r?\n5\t126385924\t.*\;LLS=0\\.909784\;"
  "\r?\n5\t126385924\t.*\;MUX=0\\.999938\;"
  "\r?\n5\t126385924\t.*\;MU1P=0\\.999938\;"
  "\r?\n5\t126385924\t.*\;DNT=G/GxG/G->G/T\;"
  "\r?\n5\t126385924\t.*\;DNL=LB/NA12878\;"
  "\r?\n5\t126385924\t.*\;DNQ=125\;"
  "\r?\n5\t126385924\t.*\;DP=113\;"
  "\r?\n5\t126385924\t.*\;AD=92,21\t"
  "\r?\n5\t126385924\t.*\t0/0:43:0\\.999946,5\\.4029e-05,0:0:0:\\.,\\.,\\.:\\.:\\.,\\.\t"
  "\r?\n5\t126385924\t.*\t0/0:51:0\\.999992,7\\.71798e-06,0:0:0:\\.,\\.,\\.:\\.:\\.,\\.\t"
  "\r?\n5\t126385924\t.*\t0/0:51:0\\.999992,7\\.71798e-06,0:0:0:0,-10\\.1127,-75\\.3322:34:34,0\t"
  "\r?\n5\t126385924\t.*\t0/1:255:6\\.26131e-31,1,8\\.45841e-38:1:1:-38\\.5043,0,-28\\.1696:35:15,20\t"
  "\r?\n5\t126385924\t.*\t0/0:43:0\\.999946,5\\.4029e-05,0:0:0:0,-9\\.26756,-87\\.0858:44:43,1\r?\n"
)

set(TrioBcftoolsXLinked-CMD @DNG_CALL_EXE@ -M xlinked -p ped/trio.ped bcftools/trio.call.vcf)
set(TrioBcftoolsXLinked-WD "@TESTDATA_DIR@/human_trio")
set(TrioBcftoolsXLinked-RESULT 0)
set(TrioBcftoolsXLinked-STDOUT
  "\r?\n#CHROM\tPOS\tID\tREF\tALT\tQUAL\tFILTER\tINFO\tFORMAT\tGL/NA12892\tGL/NA12891\tLB/NA12891\tLB/NA12878\tLB/NA12892\r?\n"
  "\r?\n5\t126385924\t\\.\tG\tT\t"
  "\r?\n5\t126385924\t.*\tGT:GQ:GP:MUP:MU1P:GL:DP:AD\t"
  "\r?\n5\t126385924\t.*\tMUP=0\\.999946\;"
  "\r?\n5\t126385924\t.*\;LLD=-22\\.6528\;"
  "\r?\n5\t126385924\t.*\;LLS=0\\.909998\;"
  "\r?\n5\t126385924\t.*\;MUX=0\\.999946\;"
  "\r?\n5\t126385924\t.*\;MU1P=0\\.999946\;"
  "\r?\n5\t126385924\t.*\;DNT=GxG/G->G/T\;"
  "\r?\n5\t126385924\t.*\;DNL=LB/NA12878\;"
  "\r?\n5\t126385924\t.*\;DNQ=126\;"
  "\r?\n5\t126385924\t.*\;DP=113\;"
  "\r?\n5\t126385924\t.*\;AD=92,21\t"
  "\r?\n5\t126385924\t.*\t0/0:43:0\\.999946,5\\.40295e-05,0:0:0:\\.,\\.,\\.:\\.:\\.,\\.\t"
  "\r?\n5\t126385924\t.*\t0:255:1,0:0:0:\\.,\\.,\\.:\\.:\\.,\\.\t"
  "\r?\n5\t126385924\t.*\t0:255:1,0:0:0:0,-75\\.3322:34:34,0\t"
  "\r?\n5\t126385924\t.*\t0/1:255:6\\.26135e-31,1,8\\.45835e-38:1:1:-38\\.5043,0,-28\\.1696:35:15,20\t"
  "\r?\n5\t126385924\t.*\t0/0:43:0\\.999946,5\\.40295e-05,0:0:0:0,-9\\.26756,-87\\.0858:44:43,1\r?\n"
)

set(TrioBcftoolsYLinked-CMD @DNG_CALL_EXE@ -m 0 -M ylinked -p ped/trio.ped bcftools/trio.call.vcf)
set(TrioBcftoolsYLinked-WD "@TESTDATA_DIR@/human_trio")
set(TrioBcftoolsYLinked-RESULT 0)
set(TrioBcftoolsYLinked-STDOUT
  "\r?\n#CHROM\tPOS\tID\tREF\tALT\tQUAL\tFILTER\tINFO\tFORMAT\tGL/NA12891\tLB/NA12891\r?\n"
  "\r?\n5\t126385924\t\\.\tG\tT\t"
  "\r?\n5\t126385924\t.*\tGT:GQ:GP:GL:DP:AD\t"
  "\r?\n5\t126385924\t.*\tMUP=-?0\;"
  "\r?\n5\t126385924\t.*\;LLD=-0\\.00775863\;"
  "\r?\n5\t126385924\t.*\;LLS=-0\\.00775863\;"
  "\r?\n5\t126385924\t.*\;MUX=0\;"
  "\r?\n5\t126385924\t.*\;MU1P=0\;"
  "\r?\n5\t126385924\t.*\;DP=34\;"
  "\r?\n5\t126385924\t.*\;AD=34,0\t"
  "\r?\n5\t126385924\t.*\t0:255:1,0:\\.,\\.,\\.:\\.:\\.,\\.\t"
  "\r?\n5\t126385924\t.*\t0:255:1,0:0,-75\\.3322:34:34,0\r?\n"
)

###############################################################################
# Test if dng-call supports regions

set(TrioRegion-CMD @DNG_CALL_EXE@ -p ped/trio.ped -m 0 -r 5:126385921-126385925 bcftools/trio.mpileup.vcf.gz)
set(TrioRegion-WD "@TESTDATA_DIR@/human_trio")
set(TrioRegion-RESULT 0)
set(TrioRegion-STDOUT
  "\r?\n5\t126385921\t"
  "\r?\n5\t126385922\t"
  "\r?\n5\t126385923\t"
  "\r?\n5\t126385924\t"
  "\r?\n5\t126385925\t"
)
set(TrioRegion-STDOUT-FAIL
  "\r?\n5\t12638592[^1-5]\t"
  "\r?\n5\t1263859[0,1,3-9][0-9]\t"
)

###############################################################################
# Test if dng-call ignores samples

set(TrioExtraSample-CMD @DNG_CALL_EXE@ -p ped/trio.ped vcf/extra_sample.vcf)
set(TrioExtraSample-WD "@TESTDATA_DIR@/human_trio")
set(TrioExtraSample-RESULT 0)
set(TrioExtraSample-STDOUT
  "\tFORMAT\tGL/NA12892\tGL/NA12891\tLB/NA12891\tLB/NA12878\tLB/NA12892\r?\n"
)
set(TrioExtraSample-FAIL
  "\tLB/FAKE(\t|\r?\n)"
)

###############################################################################
# Test how dng-call handles missing data

set(MissingData-CMD @DNG_CALL_EXE@ -m 0 --ped trio.ped trio_missing.vcf)
set(MissingData-WD "@TESTDATA_DIR@/vcf_missing_data/")
set(MissingData-RESULT 0)
set(MissingData-STDOUT
  "\r?\n1\t1\t\\.\tA\t\\.\t.*\;LLD=-8\\.68589e-09\;LLS=-8\\.68589e-09\;.*\;AD=0\t.*\t0/0:255:1:0:0:0\t0/0:255:1:0:0:0\t0/0:255:1:0:0:0\r?\n"  
  "\r?\n1\t2\t\\.\tA\t\\.\t.*\;LLD=-8\\.68589e-09\;LLS=-8\\.68589e-09\;.*\;AD=0\t.*\t0/0:255:1:0:0:0\t0/0:255:1:0:0:0\t0/0:255:1:0:0:0\r?\n"  
  "\r?\n1\t3\t\\.\tA\t\\.\t.*\;LLD=-8\\.68589e-09\;LLS=-8\\.68589e-09\;.*\;AD=0\t.*\t0/0:255:1:0:0:0\t0/0:255:1:0:0:0\t0/0:255:1:0:0:0\r?\n"  
  "\r?\n1\t4\t\\.\tA\t\\.\t.*\;LLD=-8\\.68589e-09\;LLS=-8\\.68589e-09\;.*\;AD=0\t.*\t0/0:255:1:0:0:0\t0/0:255:1:0:0:0\t0/0:255:1:0:0:0\r?\n"  

  "\r?\n1\t10\t\\.\tA\tC\t.*\;LLD=-6\\.51442e-09\;LLS=-6\\.51442e-09\;.*\;AD=0,0\t.*\t[^\t]+:0,0\t[^\t]+:0,0\t[^\t]+:0,0\r?\n"  
  "\r?\n1\t11\t\\.\tA\tC\t.*\;LLD=-6\\.51442e-09\;LLS=-6\\.51442e-09\;.*\;AD=0,0\t.*\t[^\t]+:0,0\t[^\t]+:0,0\t[^\t]+:0,0\r?\n"  
  "\r?\n1\t12\t\\.\tA\tC\t.*\;LLD=-6\\.51442e-09\;LLS=-6\\.51442e-09\;.*\;AD=0,0\t.*\t[^\t]+:0,0\t[^\t]+:0,0\t[^\t]+:0,0\r?\n"  
  "\r?\n1\t13\t\\.\tA\tC\t.*\;LLD=-6\\.51442e-09\;LLS=-6\\.51442e-09\;.*\;AD=0,0\t.*\t[^\t]+:0,0\t[^\t]+:0,0\t[^\t]+:0,0\r?\n"  

  "\r?\n1\t20\t\\.\tA\tC,G,T\t.*\;LLD=-2\\.17147e-09\;LLS=-2\\.17147e-09\;.*\;AD=0,0,0,0\t.*\t[^\t]+:0,0,0,0\t[^\t]+:0,0,0,0\t[^\t]+:0,0,0,0\r?\n"  
  "\r?\n1\t21\t\\.\tA\tC,G,T\t.*\;LLD=-2\\.17147e-09\;LLS=-2\\.17147e-09\;.*\;AD=0,0,0,0\t.*\t[^\t]+:0,0,0,0\t[^\t]+:0,0,0,0\t[^\t]+:0,0,0,0\r?\n"  
  "\r?\n1\t22\t\\.\tA\tC,G,T\t.*\;LLD=-2\\.17147e-09\;LLS=-2\\.17147e-09\;.*\;AD=0,0,0,0\t.*\t[^\t]+:0,0,0,0\t[^\t]+:0,0,0,0\t[^\t]+:0,0,0,0\r?\n"  

)

###############################################################################
# Add Tests

include("@CMAKE_CURRENT_SOURCE_DIR@/CheckProcessTest.cmake")

CheckProcessTests(DngCall.Vcf
  PartialPed
  PartialPed2
  EmptyPed
  TrioMpileup
  TrioBcftoolsAutosomal
  TrioBcftoolsXLinked
  TrioBcftoolsYLinked
  TrioRegion
  TrioExtraSample
  MissingData
)
